<%= form_for(@event, :html => { :class => "form-horizontal well"}) do |f| %>
  <% if @event.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@event.errors.count, "error") %> prohibited this event from being saved:</h2>

      <ul>
      <% @event.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="control-group">
    <%= f.label :immigrant_id, :class => "control-label" %>
    <div class="controls">
      <%= collection_select(:immigrant, :immigrant_id, Immigrant.all, :id, :nickname, :prompt => true) %>
    </div>
  </div>
  <div class="control-group">
    <%= f.label :event_time, :class => "control-label" %>
    <div class="controls">
      <%= f.text_field :event_time, :class => "datepicker", :id => "dp1" %>
    </div>
  </div>
  <div class="control-group">
    <%= f.label :event_place, :class => "control-label", :placeholder => "Where did it happen?" %>
    <div class="controls">
      <%= f.text_field :event_place %>
    </div>
  </div>
  <div class="control-group">
    <%= f.label :event_description, :class => "control-label" %>
    <div class="controls">
      <%= f.text_area :event_description, :id => "event_description", :placeholder => "What happened?" %>
    </div>
    <div id="map" style="height: 400px"></div>

    <script language="javascript" type="text/javascript">
      var map = new L.Map('map');
      var cloudmade = new L.TileLayer('http://{s}.tile.cloudmade.com/005e7c081b694ec6bfdb31507369a1a4/997/256/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
        maxZoom: 18
      });
      map.addLayer(cloudmade);

      var marker, center;
      var update_place = function(e){
        var latlng = e.latlng || e.target.getLatLng();
        $("#event_event_place").val(latlng.lat+","+latlng.lng);
      }
      var positionHandler = function(e){
          if(marker){
            marker.setLatLng(e.latlng);
          }else{
            marker = new L.Marker(e.latlng, {draggable: true});
            marker.on('dragend', update_place);
            map.addLayer(marker);
          }
        };

      var zoom = 15;
      <% if @event.latitude and @event.longitude %>
        center = new L.LatLng(<%= @event.latitude %>, <%= @event.longitude %>);
        positionHandler({latlng: center});
      <% else %>
        // by default center the map to meditereanian sea
        var center = new L.LatLng(37.6,12.4);
        zoom = 5;
      <% end %>

      map.setView(center, zoom);

      map.on('click', positionHandler);
      map.on('click', update_place);
    </script>
  </div>
  <div class="form-actions">
    <%= f.submit :class => "btn btn-primary" %>
    <%= link_to 'Back', events_path, :class => "btn" %>
  </div>
  <%= javascript_tag "$(function(){ $('#dp1').datepicker(); });"%>
<% end %>
